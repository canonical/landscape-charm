global
    log /dev/log local0
    log /dev/log local1 notice
    maxconn 4096
    user haproxy
    group haproxy
    spread-checks 0
    tune.ssl.default-dh-param 2048
    ssl-default-bind-ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:!DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:!DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:!CAMELLIA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA
    ssl-default-bind-options no-tlsv10

defaults
    log global
    mode http
    option httplog
    option dontlognull
    retries 3
    timeout queue 60000
    timeout connect 5000
    timeout client 120000
    timeout server 120000

{% block proxy_configuration %}
{% if backends %}
frontend haproxy
    mode http
    bind [::]:80 v4v6
    bind [::]:443 v4v6 ssl crt {{ haproxy_crt_dir }} alpn h2,http/1.1
    # Redirect HTTP to HTTPS
    http-request redirect scheme https unless { ssl_fc } {% for acl in acls_for_allow_http %} || {{ acl }}{% endfor %}
{% endif %}

{% for backend in backends %}
{% if backend.path_acl_required %}
    acl acl_path_{{ backend.backend_name }} path_beg -i {% for path in backend.application_data.paths %}{{ path }} {% endfor +%}
{% endif %}
    acl acl_host_{{ backend.backend_name }} req.hdr(Host) -m str {% for hostname in backend.hostname_acls%}{{hostname}} {% endfor +%}
{% if backend.deny_path_acl_required %}
    acl acl_deny_path_{{ backend.backend_name }} path_beg -i {% for path in backend.application_data.deny_paths %}{{ path }} {% endfor +%}
{% endif %}
    use_backend {{ backend.backend_name }} if {% if backend.path_acl_required %}acl_path_{{ backend.backend_name }}{% endif %} acl_host_{{ backend.backend_name }} {% if backend.deny_path_acl_required %}!acl_deny_path_{{ backend.backend_name }}{% endif +%}
{% endfor %}

    default_backend default

{% for backend in backends %}
backend {{ backend.backend_name }}
    balance {{ backend.load_balancing_configuration }}
{% if backend.consistent_hashing %}
    hash-type consistent
{% endif %}
    timeout server {{ backend.application_data.timeout.server }}s
    timeout connect {{ backend.application_data.timeout.connect }}s
    timeout queue {{ backend.application_data.timeout.queue }}s
{% if backend.application_data.retry %}
    retries {{ backend.application_data.retry.count }}
{% if backend.application_data.retry.redispatch %}
    option redispatch
{% endif %}
{% endif %}

{% if backend.application_data.http_server_close %}
    option http-server-close
{% endif %}

    option httpchk {% if backend.application_data.check.path %}GET {{ backend.application_data.check.path }}{% endif +%}
{% if backend.application_data.check.port %}
    http-check connect port {{ backend.application_data.check.port }}
{% endif %}
    http-check send hdr Host {{ backend.hostname_acls[0] }}
{% if backend.application_data.rate_limit %}
    http-request track-sc0 src table  haproxy_peers/{{ backend.backend_name }}_rate_limit
    http-request {{ backend.application_data.rate_limit.policy.value }} if { sc_http_req_rate(0,haproxy_peers/{{ backend.backend_name }}_rate_limit) gt {{ backend.application_data.rate_limit.connections_per_minute }} }
{% endif %}
{% if backend.application_data.bandwidth_limit.download %}

    filter bwlim-out download default-limit {{ backend.application_data.bandwidth_limit.download }} default-period 1s
    http-response set-bandwidth-limit download
{% endif %}
{% if backend.application_data.bandwidth_limit.upload %}
    filter bwlim-in upload default-limit {{ backend.application_data.bandwidth_limit.upload }} default-period 1s
    http-request set-bandwidth-limit upload
{% endif %}
{% for rewrite_configuration in backend.rewrite_configurations %}
    http-request {{ rewrite_configuration }}
{% endfor %}
{% for server in backend.servers %}
    server {{ server.server_name }} {{ server.address }}:{{ server.port }}{% if server.check %} check inter {{ server.check.interval }}s rise {{ server.check.rise }} fall {{ server.check.fall }}{% endif +%}{% if server.protocol == "https" %} ssl ca-file {{ haproxy_cas_file }} alpn h2,http/1.1{% endif +%}
{% endfor %}
{% endfor %}

{% endblock %}
